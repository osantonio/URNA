{% extends "base.html" %}

{% block title %}Perfil: {{ usuario.nombre_completo }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-background text-foreground">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10">

        <!-- Header con breadcrumb -->
        <div class="mb-6">
            <a href="/votantes/"
                class="text-sm text-muted-foreground hover:text-foreground transition-colors inline-flex items-center gap-1">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
                Volver al listado
            </a>
        </div>

        <!-- Perfil Header -->
        <div class="bg-card border border-border rounded-lg p-6 mb-6">
            <div class="flex items-start justify-between">
                <div>
                    <h1 class="text-3xl font-bold mb-2">{{ usuario.nombre_completo }}</h1>
                    <div class="flex items-center gap-3">
                        <div class="id-badge" data-id="{{ usuario.identificacion }}" tabindex="0" role="button"
                            aria-label="Copiar identificaci√≥n">
                            <span class="id-prefix">CC</span><span class="id-number">{{ usuario.identificacion }}</span>
                        </div>
                        <span class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium border
                            {% if usuario.rol.value == 'Estratega' %} bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-900/30 dark:text-purple-300 dark:border-purple-800
                            {% elif usuario.rol.value == 'Coordinador' %} bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800
                            {% elif usuario.rol.value == 'Jefe de Zona' %} bg-cyan-50 text-cyan-700 border-cyan-200 dark:bg-cyan-900/30 dark:text-cyan-300 dark:border-cyan-800
                            {% elif usuario.rol.value == 'L√≠der' %} bg-green-50 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-300 dark:border-green-800
                            {% elif usuario.rol.value == 'Activista' %} bg-yellow-50 text-yellow-800 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-800
                            {% else %} bg-secondary text-secondary-foreground border-border {% endif %}">
                            {{ usuario.rol.value }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid de informaci√≥n y m√©tricas -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

            <!-- Informaci√≥n personal -->
            <div class="lg:col-span-2 bg-card border border-border rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Informaci√≥n Personal</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-xs text-muted-foreground font-medium mb-1">Tel√©fono</p>
                        {% if usuario.telefono and usuario.telefono|length == 10 and usuario.telefono.startswith('3') %}
                        <a href="https://wa.me/57{{ usuario.telefono }}" target="_blank" rel="noopener noreferrer"
                            class="whatsapp-link">
                            <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M20.52 3.48A11.8 11.8 0 0012.01.5C5.76.5.99 5.27 1 11.52a11.5 11.5 0 001.52 5.8L1 23l5.83-1.48a11.78 11.78 0 005.2 1.25h.01c6.25 0 11.02-4.77 11.02-11.02 0-2.95-1.15-5.72-3.55-8.27zM12.04 21.02h-.01a9.74 9.74 0 01-4.97-1.36l-.36-.21-3.45.88.92-3.37-.24-.35A9.45 9.45 0 012.98 11.5c0-5.03 4.03-9.06 9.06-9.06 2.43 0 4.7.95 6.42 2.68a9.02 9.02 0 012.65 6.37c0 5.03-4.03 9.06-9.06 9.06zm5.41-7.06c-.3-.15-1.77-.87-2.04-.97-.27-.1-.47-.15-.67.15-.2.29-.77.96-.95 1.16-.17.2-.35.22-.65.07-.3-.15-1.26-.46-2.4-1.47-.89-.79-1.49-1.76-1.66-2.06-.17-.3-.02-.47.13-.62.14-.14.3-.35.45-.52.15-.17.2-.29.3-.49.1-.2.05-.37-.02-.52-.07-.15-.67-1.62-.92-2.22-.24-.6-.49-.51-.67-.51h-.57c-.2 0-.52.07-.8.37-.27.29-1.05 1.03-1.05 2.52s1.08 2.92 1.23 3.12c.15.2 2.13 3.25 5.17 4.55.72.31 1.29.49 1.73.62.73.23 1.4.2 1.93.12.59-.09 1.77-.72 2.02-1.41.25-.69.25-1.28.18-1.41-.07-.13-.27-.2-.57-.34z" />
                            </svg>
                            <span>{{ usuario.telefono }}</span>
                        </a>
                        {% elif usuario.telefono %}
                        <p class="text-sm">{{ usuario.telefono }}</p>
                        {% else %}
                        <p class="text-sm text-muted-foreground italic">Sin registro</p>
                        {% endif %}
                    </div>

                    <div>
                        <p class="text-xs text-muted-foreground font-medium mb-1">Correo Electr√≥nico</p>
                        <p class="text-sm">{{ usuario.correoelectronico or '‚Äî' }}</p>
                    </div>

                    <div>
                        <p class="text-xs text-muted-foreground font-medium mb-1">Edad</p>
                        <p class="text-sm">{{ usuario.edad or '‚Äî' }} a√±os</p>
                    </div>

                    <div>
                        <p class="text-xs text-muted-foreground font-medium mb-1">Sexo</p>
                        <p class="text-sm">{{ usuario.sexo.value if usuario.sexo else '‚Äî' }}</p>
                    </div>

                    <div>
                        <p class="text-xs text-muted-foreground font-medium mb-1">Barrio/Vereda</p>
                        <p class="text-sm">{{ usuario.barrio_vereda or '‚Äî' }}</p>
                    </div>

                    <div>
                        <p class="text-xs text-muted-foreground font-medium mb-1">Lugar de Votaci√≥n</p>
                        <p class="text-sm">{{ usuario.lugar_votacion or '‚Äî' }}</p>
                    </div>

                    <div>
                        <p class="text-xs text-muted-foreground font-medium mb-1">Mesa</p>
                        {% if usuario.mesa_votacion %}
                        <span
                            class="inline-flex items-center justify-center rounded border border-border bg-secondary px-2.5 py-0.5 text-xs font-medium text-secondary-foreground">
                            {{ usuario.mesa_votacion }}
                        </span>
                        {% else %}
                        <p class="text-sm text-muted-foreground">‚Äî</p>
                        {% endif %}
                    </div>

                    <div>
                        <p class="text-xs text-muted-foreground font-medium mb-1">Referido por</p>
                        {% if referente %}
                        <a href="/votantes/{{ referente.identificacion }}" class="text-sm text-primary hover:underline">
                            {{ referente.nombre_completo }}
                        </a>
                        {% else %}
                        <p class="text-sm text-muted-foreground">‚Äî</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- M√©tricas -->
            <div class="space-y-4">
                <div class="bg-card border border-border rounded-lg p-6">
                    <p class="text-sm text-muted-foreground mb-1">Total de Red</p>
                    <p class="text-3xl font-bold">{{ metricas.total_red }}</p>
                    <p class="text-xs text-muted-foreground mt-1">referidos en toda la red</p>
                </div>

                <div class="bg-card border border-border rounded-lg p-6">
                    <p class="text-sm text-muted-foreground mb-1">Profundidad</p>
                    <p class="text-3xl font-bold">{{ metricas.niveles_profundidad }}</p>
                    <p class="text-xs text-muted-foreground mt-1">niveles de jerarqu√≠a</p>
                </div>

                <div class="bg-card border border-border rounded-lg p-6">
                    <p class="text-sm text-muted-foreground mb-2">Distribuci√≥n por Rol</p>
                    <div class="space-y-2">
                        {% for rol, cantidad in metricas.por_rol.items() %}
                        <div class="flex justify-between items-center text-sm">
                            <span>{{ rol }}</span>
                            <span class="font-medium">{{ cantidad }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- √Årbol jer√°rquico de referidos en formato tabla -->
        <div class="bg-card border border-border rounded-lg shadow-sm overflow-hidden">
            <div class="p-6 pb-4">
                <h2 class="text-xl font-semibold">Red de Referidos</h2>
            </div>

            {% if referidos_agrupados %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-border text-left text-sm">
                    <thead class="bg-secondary">
                        <tr>
                            <th scope="col" class="px-6 py-4 font-semibold text-foreground">Votante</th>
                            <th scope="col" class="px-6 py-4 font-semibold text-foreground">Contacto</th>
                            <th scope="col" class="px-6 py-4 font-semibold text-foreground">Puesto y Mesa</th>
                            <th scope="col" class="px-6 py-4 font-semibold text-foreground">Rol</th>
                            <th scope="col" class="px-6 py-4 font-semibold text-right text-foreground">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="referidos-body" class="divide-y divide-border bg-card">
                        {% for rol, personas in referidos_agrupados.items() %}
                        <tr class="tree-group-row bg-muted/30" data-rol="{{ rol }}">
                            <td colspan="5" class="px-6 py-3">
                                <div class="flex items-center gap-2 cursor-pointer font-semibold"
                                    onclick="toggleGroupRow(this)">
                                    <span class="tree-group__icon text-muted-foreground">[‚ñº]</span>
                                    <span>üë• {{ rol }}s ({{ personas|length }})</span>
                                </div>
                            </td>
                        </tr>
                        {% for persona in personas %}
                        <tr class="tree-person-row group hover:bg-muted/50 transition-colors"
                            data-id="{{ persona.identificacion }}" data-rol="{{ rol }}" data-nivel="1">
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2" style="padding-left: 1.5rem;">
                                    <span class="tree-person__icon cursor-pointer" onclick="togglePersonRow(this)"
                                        title="{% if persona.tiene_referidos %}Expandir{% else %}Sin referidos{% endif %}">
                                        {% if persona.tiene_referidos %}[‚ñ∂]{% else %}üë§{% endif %}
                                    </span>
                                    <div class="font-medium text-foreground">{{ persona.nombre_completo }}</div>
                                    <div class="relative">
                                        <div class="id-badge id-badge--compact" data-id="{{ persona.identificacion }}"
                                            tabindex="0" role="button" aria-label="Copiar identificaci√≥n">
                                            <span class="id-prefix">CC</span><span class="id-number">{{
                                                persona.identificacion }}</span>
                                        </div>
                                        <span class="copy-tooltip" aria-hidden="true">Copiado</span>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                {% if persona.telefono and persona.telefono|length == 10 and
                                persona.telefono.startswith('3') %}
                                <a href="https://wa.me/57{{ persona.telefono }}" target="_blank"
                                    rel="noopener noreferrer" class="whatsapp-link">
                                    <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor">
                                        <path
                                            d="M20.52 3.48A11.8 11.8 0 0012.01.5C5.76.5.99 5.27 1 11.52a11.5 11.5 0 001.52 5.8L1 23l5.83-1.48a11.78 11.78 0 005.2 1.25h.01c6.25 0 11.02-4.77 11.02-11.02 0-2.95-1.15-5.72-3.55-8.27zM12.04 21.02h-.01a9.74 9.74 0 01-4.97-1.36l-.36-.21-3.45.88.92-3.37-.24-.35A9.45 9.45 0 012.98 11.5c0-5.03 4.03-9.06 9.06-9.06 2.43 0 4.7.95 6.42 2.68a9.02 9.02 0 012.65 6.37c0 5.03-4.03 9.06-9.06 9.06zm5.41-7.06c-.3-.15-1.77-.87-2.04-.97-.27-.1-.47-.15-.67.15-.2.29-.77.96-.95 1.16-.17.2-.35.22-.65.07-.3-.15-1.26-.46-2.4-1.47-.89-.79-1.49-1.76-1.66-2.06-.17-.3-.02-.47.13-.62.14-.14.3-.35.45-.52.15-.17.2-.29.3-.49.1-.2.05-.37-.02-.52-.07-.15-.67-1.62-.92-2.22-.24-.6-.49-.51-.67-.51h-.57c-.2 0-.52.07-.8.37-.27.29-1.05 1.03-1.05 2.52s1.08 2.92 1.23 3.12c.15.2 2.13 3.25 5.17 4.55.72.31 1.29.49 1.73.62.73.23 1.4.2 1.93.12.59-.09 1.77-.72 2.02-1.41.25-.69.25-1.28.18-1.41-.07-.13-.27-.2-.57-.34z" />
                                    </svg>
                                    <span>{{ persona.telefono }}</span>
                                </a>
                                {% elif persona.telefono %}
                                <span class="text-muted-foreground text-xs">{{ persona.telefono }}</span>
                                {% else %}
                                <span class="text-muted-foreground/40 italic text-xs">Sin registro</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2 flex-wrap">
                                    {% if persona.lugar_votacion %}
                                    <span class="text-foreground text-xs font-medium">{{ persona.lugar_votacion }}</span>
                                    {% else %}
                                    <span class="text-muted-foreground/40 italic text-xs">Puesto no registrado</span>
                                    {% endif %}
                                    
                                    {% if persona.mesa_votacion %}
                                    <div class="flex items-center gap-1.5">
                                        <span class="inline-flex items-center justify-center rounded border border-border bg-secondary px-1.5 py-0.5 text-xs font-medium text-secondary-foreground">
                                            {{ persona.mesa_votacion }}
                                        </span>
                                    </div>
                                    {% else %}
                                    <span class="text-muted-foreground/40 italic text-[10px]">Sin mesa</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium border
                                    {% if persona.rol == 'Estratega' %} bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-900/30 dark:text-purple-300 dark:border-purple-800
                                    {% elif persona.rol == 'Coordinador' %} bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800
                                    {% elif persona.rol == 'Jefe de Zona' %} bg-cyan-50 text-cyan-700 border-cyan-200 dark:bg-cyan-900/30 dark:text-cyan-300 dark:border-cyan-800
                                    {% elif persona.rol == 'L√≠der' %} bg-green-50 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-300 dark:border-green-800
                                    {% elif persona.rol == 'Activista' %} bg-yellow-50 text-yellow-800 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-800
                                    {% else %} bg-secondary text-secondary-foreground border-border {% endif %}">
                                    {{ persona.rol }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <a href="/votantes/{{ persona.identificacion }}"
                                    class="text-muted-foreground hover:text-foreground transition-colors"
                                    title="Ver perfil">
                                    <svg class="h-4 w-4 inline-block" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted-foreground text-center py-8">Sin referidos directos</p>
            {% endif %}
        </div>

    </div>
</div>

<div class="copy-tooltip" aria-hidden="true">Copiado</div>

{% endblock %}

{% block extra_js %}
<script>
    const expandedNodes = new Set();

    function toggleGroupRow(headerElement) {
        const groupRow = headerElement.closest('tr');
        const rol = groupRow.dataset.rol;
        const icon = headerElement.querySelector('.tree-group__icon');
        const personRows = document.querySelectorAll(`tr.tree-person-row[data-rol="${rol}"][data-nivel="1"]`);
        const isCollapsed = icon.textContent === '[‚ñ∂]';

        if (isCollapsed) {
            icon.textContent = '[‚ñº]';
            personRows.forEach(row => row.style.display = '');
        } else {
            icon.textContent = '[‚ñ∂]';
            personRows.forEach(row => {
                row.style.display = 'none';
                const personId = row.dataset.id;
                const childRows = document.querySelectorAll(`tr[data-parent="${personId}"]`);
                childRows.forEach(child => child.remove());
                expandedNodes.delete(personId);
            });
        }
    }

    async function togglePersonRow(iconElement) {
        const personRow = iconElement.closest('tr');
        const personId = personRow.dataset.id;
        const nivel = parseInt(personRow.dataset.nivel);

        if (iconElement.textContent === 'üë§') return;

        if (expandedNodes.has(personId)) {
            const childRows = document.querySelectorAll(`tr[data-parent="${personId}"]`);
            childRows.forEach(row => row.remove());
            iconElement.textContent = '[‚ñ∂]';
            expandedNodes.delete(personId);
            return;
        }

        iconElement.textContent = '‚è≥';

        try {
            const response = await fetch(`/votantes/${personId}/referidos`);
            if (!response.ok) throw new Error('Error al cargar');

            const data = await response.json();
            const tbody = personRow.parentElement;
            let insertAfter = personRow;

            for (const [rol, personas] of Object.entries(data.referidos_por_rol)) {
                if (personas.length === 0) continue;

                const groupRow = createGroupRow(rol, personas.length, personId, nivel + 1);
                insertAfter.insertAdjacentElement('afterend', groupRow);
                insertAfter = groupRow;

                for (const persona of personas) {
                    const personaRow = createPersonRow(persona, personId, nivel + 1);
                    insertAfter.insertAdjacentElement('afterend', personaRow);
                    insertAfter = personaRow;
                }
            }

            iconElement.textContent = '[‚ñº]';
            expandedNodes.add(personId);
        } catch (error) {
            iconElement.textContent = '[‚ñ∂]';
            alert('Error al cargar referidos');
        }
    }

    function createGroupRow(rol, count, parentId, nivel) {
        const tr = document.createElement('tr');
        tr.className = 'tree-group-row bg-muted/30';
        tr.dataset.parent = parentId;
        tr.dataset.nivel = nivel;
        tr.innerHTML = `
            <td colspan="5" class="px-6 py-3" style="padding-left: ${nivel * 1.5 + 1.5}rem;">
                <div class="flex items-center gap-2 cursor-pointer font-semibold" onclick="toggleGroupRow(this)">
                    <span class="tree-group__icon text-muted-foreground">[‚ñº]</span>
                    <span>üë• ${rol}s (${count})</span>
                </div>
            </td>
        `;
        return tr;
    }

    function createPersonRow(persona, parentId, nivel) {
        const tr = document.createElement('tr');
        tr.className = 'tree-person-row group hover:bg-muted/50 transition-colors';
        tr.dataset.id = persona.identificacion;
        tr.dataset.parent = parentId;
        tr.dataset.nivel = nivel;

        const icon = persona.tiene_referidos ? '[‚ñ∂]' : 'üë§';
        const paddingLeft = nivel * 1.5 + 1.5;

        const telefono = persona.telefono && persona.telefono.length === 10 && persona.telefono.startsWith('3')
            ? `<a href="https://wa.me/57${persona.telefono}" target="_blank" rel="noopener noreferrer" class="whatsapp-link">
                <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M20.52 3.48A11.8 11.8 0 0012.01.5C5.76.5.99 5.27 1 11.52a11.5 11.5 0 001.52 5.8L1 23l5.83-1.48a11.78 11.78 0 005.2 1.25h.01c6.25 0 11.02-4.77 11.02-11.02 0-2.95-1.15-5.72-3.55-8.27zM12.04 21.02h-.01a9.74 9.74 0 01-4.97-1.36l-.36-.21-3.45.88.92-3.37-.24-.35A9.45 9.45 0 012.98 11.5c0-5.03 4.03-9.06 9.06-9.06 2.43 0 4.7.95 6.42 2.68a9.02 9.02 0 012.65 6.37c0 5.03-4.03 9.06-9.06 9.06zm5.41-7.06c-.3-.15-1.77-.87-2.04-.97-.27-.1-.47-.15-.67.15-.2.29-.77.96-.95 1.16-.17.2-.35.22-.65.07-.3-.15-1.26-.46-2.4-1.47-.89-.79-1.49-1.76-1.66-2.06-.17-.3-.02-.47.13-.62.14-.14.3-.35.45-.52.15-.17.2-.29.3-.49.1-.2.05-.37-.02-.52-.07-.15-.67-1.62-.92-2.22-.24-.6-.49-.51-.67-.51h-.57c-.2 0-.52.07-.8.37-.27.29-1.05 1.03-1.05 2.52s1.08 2.92 1.23 3.12c.15.2 2.13 3.25 5.17 4.55.72.31 1.29.49 1.73.62.73.23 1.4.2 1.93.12.59-.09 1.77-.72 2.02-1.41.25-.69.25-1.28.18-1.41-.07-.13-.27-.2-.57-.34z"/></svg>
                <span>${persona.telefono}</span>
            </a>`
            : persona.telefono
                ? `<span class="text-muted-foreground text-xs">${persona.telefono}</span>`
                : `<span class="text-muted-foreground/40 italic text-xs">Sin registro</span>`;

        const puestoMesa = `
            <div class="flex items-center gap-2 flex-wrap">
                ${persona.lugar_votacion
                ? `<span class="text-foreground text-xs font-medium">${persona.lugar_votacion}</span>`
                : `<span class="text-muted-foreground/40 italic text-xs">Puesto no registrado</span>`
            }
                ${persona.mesa_votacion
                ? `<div class="flex items-center gap-1.5">
                        <span class="inline-flex items-center justify-center rounded border border-border bg-secondary px-1.5 py-0.5 text-xs font-medium text-secondary-foreground">${persona.mesa_votacion}</span>
                       </div>`
                : `<span class="text-muted-foreground/40 italic text-[10px]">Sin mesa</span>`
            }
            </div>
        `;

        const rolClass = persona.rol === 'Estratega' ? 'bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-900/30 dark:text-purple-300 dark:border-purple-800'
            : persona.rol === 'Coordinador' ? 'bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800'
                : persona.rol === 'Jefe de Zona' ? 'bg-cyan-50 text-cyan-700 border-cyan-200 dark:bg-cyan-900/30 dark:text-cyan-300 dark:border-cyan-800'
                    : persona.rol === 'L√≠der' ? 'bg-green-50 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-300 dark:border-green-800'
                        : persona.rol === 'Activista' ? 'bg-yellow-50 text-yellow-800 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-800'
                            : 'bg-secondary text-secondary-foreground border-border';

        tr.innerHTML = `
            <td class="px-6 py-4">
                <div class="flex items-center gap-2" style="padding-left: ${paddingLeft}rem;">
                    <span class="tree-person__icon cursor-pointer" onclick="togglePersonRow(this)" title="${persona.tiene_referidos ? 'Expandir' : 'Sin referidos'}">
                        ${icon}
                    </span>
                    <div class="font-medium text-foreground">${persona.nombre_completo}</div>
                    <div class="relative">
                        <div class="id-badge id-badge--compact" data-id="${persona.identificacion}" tabindex="0" role="button" aria-label="Copiar identificaci√≥n">
                            <span class="id-prefix">CC</span><span class="id-number">${persona.identificacion}</span>
                        </div>
                        <span class="copy-tooltip" aria-hidden="true">Copiado</span>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4">${telefono}</td>
            <td class="px-6 py-4">${puestoMesa}</td>
            <td class="px-6 py-4">
                <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium border ${rolClass}">
                    ${persona.rol}
                </span>
            </td>
            <td class="px-6 py-4 text-right">
                <a href="/votantes/${persona.identificacion}" class="text-muted-foreground hover:text-foreground transition-colors" title="Ver perfil">
                    <svg class="h-4 w-4 inline-block" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </a>
            </td>
        `;

        setTimeout(() => wireCopyIds(), 0);
        return tr;
    }

    function wireCopyIds() {
        const badges = Array.from(document.querySelectorAll('.id-badge'));
        badges.forEach(badge => {
            if (badge.dataset.wired) return;
            badge.dataset.wired = 'true';

            const copyNumber = () => {
                const id = badge.getAttribute('data-id') || '';
                if (!id) return;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(id).then(() => {
                        const tooltip = badge.parentElement.querySelector('.copy-tooltip');
                        if (tooltip) {
                            tooltip.classList.add('visible');
                            setTimeout(() => tooltip.classList.remove('visible'), 1200);
                        }
                    }).catch(() => { });
                }
            };
            badge.addEventListener('click', copyNumber);
            badge.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    copyNumber();
                }
            });
        });
    }

    wireCopyIds();
</script>
{% endblock %}